<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Refined Transforming Futuristic Car in Three.js</title>
    <style>
      body {
          margin: 0;
          overflow: hidden;
          background-color: #000;
          font-family: Arial, sans-serif;
      }
      canvas {
          display: block;
      }
      #ui {
          position: absolute;
          top: 20px;
          left: 20px;
          color: white;
          z-index: 100;
          display: flex;
          flex-direction: column;
          gap: 10px;
      }
      button {
          padding: 10px 20px;
          background: rgba(0, 102, 255, 0.7);
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 16px;
          transition: background 0.3s;
      }
      button:hover {
          background: rgba(0, 102, 255, 0.9);
      }
      .speed-display {
          background: rgba(0, 0, 0, 0.5);
          padding: 10px 20px;
          border-radius: 5px;
          font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="ui">
      <button id="transformButton">Transform</button>
      <div class="speed-display">Speed: <span id="speedValue">0</span> km/h</div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script>
      // Initialize scene, camera, and renderer
      const scene = new THREE.Scene();
      scene.background = new THREE.Color(0x050515); // Darker background
      scene.fog = new THREE.Fog(0x050515, 100, 500); // Fog for depth

      const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
      camera.position.set(5,5,5);

      const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
      renderer.setSize(window.innerWidth, window.innerHeight);
      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;
      renderer.toneMapping = THREE.ACESFilmicToneMapping;
      renderer.toneMappingExposure = 1.2;
      document.body.appendChild(renderer.domElement);

      // Add ambient light
      const ambientLight = new THREE.AmbientLight(0x404060, 0.3);
      scene.add(ambientLight);

      // Add directional light (moonlight)
      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.6);
      directionalLight.position.set(100, 200, 100);
      directionalLight.castShadow = true;
      directionalLight.shadow.mapSize.width = 2048;
      directionalLight.shadow.mapSize.height = 2048;
      scene.add(directionalLight);

      // Add hemisphere light for natural illumination
      const hemisphereLight = new THREE.HemisphereLight(0x606080, 0x202040, 0.3);
      scene.add(hemisphereLight);

      // Add neon point lights for city ambiance
      const neonLightBlue = new THREE.PointLight(0x0066ff, 1, 100);
      neonLightBlue.position.set(50, 30, 50);
      scene.add(neonLightBlue);

      const neonLightPurple = new THREE.PointLight(0x9900ff, 1, 100);
      neonLightPurple.position.set(-50, 30, -50);
      scene.add(neonLightPurple);

      // Create the car group
      const car = new THREE.Group();
      car.position.y = 1;
      scene.add(car);

      // Car body (main chassis with smoother design)
      const bodyGeometry = new THREE.BoxGeometry(5.5, 0.8, 2.2);
      bodyGeometry.attributes.uv.array[1] = 0.5; // Adjust UV for better texture mapping
      const bodyMaterial = new THREE.MeshStandardMaterial({
          color: 0x1a1a33,
          metalness: 0.7,
          roughness: 0.2,
          emissive: 0x111133,
          emissiveIntensity: 0.1,
          envMapIntensity: 0.5
      });
      const body = new THREE.Mesh(bodyGeometry, bodyMaterial);
      body.position.y = 0.4;
      body.castShadow = true;
      body.receiveShadow = true;
      car.add(body);

      // Front of the car (sleek, angular design)
      const frontGeometry = new THREE.BoxGeometry(1.8, 0.6, 1.2);
      const frontMaterial = new THREE.MeshStandardMaterial({
          color: 0x2a2a44,
          metalness: 0.8,
          roughness: 0.1,
          emissive: 0x330066,
          emissiveIntensity: 0.2
      });
      const front = new THREE.Mesh(frontGeometry, frontMaterial);
      front.position.set(2.1, 0.4, 0);
      car.add(front);

      // Neon accents (glowing blue/purple lines with rounded edges)
      const accentGeometry = new THREE.BoxGeometry(0.1, 0.1, 2.3);
      const accentMaterial = new THREE.MeshStandardMaterial({
          color: 0x00aaff,
          emissive: 0x00aaff,
          emissiveIntensity: 1.5,
          metalness: 0.3,
          roughness: 0.2
      });

      // Side accents
      const leftAccent = new THREE.Mesh(accentGeometry, accentMaterial);
      leftAccent.position.set(-2.65, 0.4, 0);
      car.add(leftAccent);

      const rightAccent = new THREE.Mesh(accentGeometry, accentMaterial);
      rightAccent.position.set(-2.65, 0.4, 0);
      car.add(rightAccent);

      // Front accent
      const frontAccentGeometry = new THREE.BoxGeometry(0.1, 0.15, 1.3);
      const frontAccent = new THREE.Mesh(frontAccentGeometry, accentMaterial);
      frontAccent.position.set(2.7, 0.4, 0);
      car.add(frontAccent);

      // Rear accent
      const rearAccent = new THREE.Mesh(frontAccentGeometry, accentMaterial);
      rearAccent.position.set(-2.7, 0.4, 0);
      car.add(rearAccent);

      // Transparent cockpit with more detail
      const cockpitGeometry = new THREE.BoxGeometry(1.6, 0.5, 1.1);
      const cockpitMaterial = new THREE.MeshStandardMaterial({
          color: 0xaaaaff,
          transparent: true,
          opacity: 0.4,
          metalness: 0.1,
          roughness: 0.1,
          envMapIntensity: 0.3
      });
      const cockpit = new THREE.Mesh(cockpitGeometry, cockpitMaterial);
      cockpit.position.set(0.6, 0.9, 0);
      car.add(cockpit);

      // Holographic display inside the cockpit
      const displayGeometry = new THREE.BoxGeometry(0.9, 0.02, 0.4);
      const displayMaterial = new THREE.MeshStandardMaterial({
          color: 0x00ffff,
          emissive: 0x00ffff,
          emissiveIntensity: 2,
          transparent: true,
          opacity: 0.9
      });
      const display = new THREE.Mesh(displayGeometry, displayMaterial);
      display.position.set(1.1, 0.9, 0);
      car.add(display);

      // Wheels (initially folded in flying mode)
      const wheelGeometry = new THREE.CylinderGeometry(0.3, 0.3, 0.2, 32);
      const wheelMaterial = new THREE.MeshStandardMaterial({
          color: 0x111111,
          metalness: 0.8,
          roughness: 0.2
      });

      // Front-left wheel
      const wheelFL = new THREE.Mesh(wheelGeometry, wheelMaterial);
      wheelFL.position.set(-2, 0.3, 1.1);
      wheelFL.rotation.z = Math.PI / 2;
      wheelFL.castShadow = true;
      car.add(wheelFL);

      // Front-right wheel
      const wheelFR = new THREE.Mesh(wheelGeometry, wheelMaterial);
      wheelFR.position.set(-2, 0.3, -1.1);
      wheelFR.rotation.z = Math.PI / 2;
      wheelFR.castShadow = true;
      car.add(wheelFR);

      // Back-left wheel
      const wheelBL = new THREE.Mesh(wheelGeometry, wheelMaterial);
      wheelBL.position.set(2, 0.3, 1.1);
      wheelBL.rotation.z = Math.PI / 2;
      wheelBL.castShadow = true;
      car.add(wheelBL);

      // Back-right wheel
      const wheelBR = new THREE.Mesh(wheelGeometry, wheelMaterial);
      wheelBR.position.set(2, 0.3, -1.1);
      wheelBR.rotation.z = Math.PI / 2;
      wheelBR.castShadow = true;
      car.add(wheelBR);

      // Glowing rims with more detail
      const rimGeometry = new THREE.TorusGeometry(0.32, 0.04, 16, 64);
      const rimMaterial = new THREE.MeshStandardMaterial({
          color: 0x9900ff,
          emissive: 0x9900ff,
          emissiveIntensity: 2,
          metalness: 0.5,
          roughness: 0.1
      });

      // Front-left rim
      const rimFL = new THREE.Mesh(rimGeometry, rimMaterial);
      rimFL.position.set(-2, 0.3, 1.1);
      rimFL.rotation.x = Math.PI / 2;
      car.add(rimFL);

      // Front-right rim
      const rimFR = new THREE.Mesh(rimGeometry, rimMaterial);
      rimFR.position.set(-2, 0.3, -1.1);
      rimFR.rotation.x = Math.PI / 2;
      car.add(rimFR);

      // Back-left rim
      const rimBL = new THREE.Mesh(rimGeometry, rimMaterial);
      rimBL.position.set(2, 0.3, 1.1);
      rimBL.rotation.x = Math.PI / 2;
      car.add(rimBL);

      // Back-right rim
      const rimBR = new THREE.Mesh(rimGeometry, rimMaterial);
      rimBR.position.set(2, 0.3, -1.1);
      rimBR.rotation.x = Math.PI / 2;
      car.add(rimBR);

      // Headlights with improved design
      const headlightGeometry = new THREE.ConeGeometry(0.2, 0.4, 8);
      const headlightMaterial = new THREE.MeshStandardMaterial({
          color: 0x00aaff,
          emissive: 0x00aaff,
          emissiveIntensity: 3,
          transparent: true,
          opacity: 0.9
      });

      // Left headlight
      const headlightLeft = new THREE.Mesh(headlightGeometry, headlightMaterial);
      headlightLeft.position.set(2.7, 0.5, 0.5);
      headlightLeft.rotation.x = Math.PI / 2;
      headlightLeft.rotation.z = Math.PI;
      car.add(headlightLeft);

      // Right headlight
      const headlightRight = new THREE.Mesh(headlightGeometry, headlightMaterial);
      headlightRight.position.set(2.7, 0.5, -0.5);
      headlightRight.rotation.x = Math.PI / 2;
      headlightRight.rotation.z = Math.PI;
      car.add(headlightRight);

      // Wing flaps (for flying mode, more detailed)
      const wingGeometry = new THREE.BoxGeometry(1.8, 0.05, 0.3);
      const wingMaterial = new THREE.MeshStandardMaterial({
          color: 0x2a2a44,
          metalness: 0.8,
          roughness: 0.1,
          emissive: 0x330066,
          emissiveIntensity: 0.2
      });

      // Left wing
      const wingLeft = new THREE.Mesh(wingGeometry, wingMaterial);
      wingLeft.position.set(-1.2, 0.8, 1.6);
      wingLeft.rotation.z = Math.PI / 4;
      car.add(wingLeft);

      // Right wing
      const wingRight = new THREE.Mesh(wingGeometry, wingMaterial);
      wingRight.position.set(-1.2, 0.8, -1.6);
      wingRight.rotation.z = -Math.PI / 4;
      car.add(wingRight);

      // Exhaust effect (for flying mode, dynamic)
      const exhaustGeometry = new THREE.ConeGeometry(0.15, 0.4, 8);
      const exhaustMaterial = new THREE.MeshStandardMaterial({
          color: 0xff6600,
          emissive: 0xff6600,
          emissiveIntensity: 2,
          transparent: true,
          opacity: 0
      });

      // Left exhaust
      const exhaustLeft = new THREE.Mesh(exhaustGeometry, exhaustMaterial);
      exhaustLeft.position.set(-2.6, 0.6, 0.8);
      exhaustLeft.rotation.x = Math.PI / 2;
      car.add(exhaustLeft);

      // Right exhaust
      const exhaustRight = new THREE.Mesh(exhaustGeometry, exhaustMaterial);
      exhaustRight.position.set(-2.6, 0.6, -0.8);
      exhaustRight.rotation.x = Math.PI / 2;
      car.add(exhaustRight);

      // Spoiler (for road mode)
      const spoilerGeometry = new THREE.BoxGeometry(1.2, 0.1, 0.2);
      const spoilerMaterial = new THREE.MeshStandardMaterial({
          color: 0x2a2a44,
          metalness: 0.8,
          roughness: 0.1,
          emissive: 0x330066,
          emissiveIntensity: 0.2
      });
      const spoiler = new THREE.Mesh(spoilerGeometry, spoilerMaterial);
      spoiler.position.set(-2.7, 0.8, 0);
      spoiler.rotation.x = Math.PI / 4;
      spoiler.visible = false; // Hidden in flying mode
      car.add(spoiler);

      // Ground (reflective with improved material)
      const groundGeometry = new THREE.PlaneGeometry(500, 500);
      const groundMaterial = new THREE.MeshStandardMaterial({
          color: 0x111111,
          roughness: 0.7,
          metalness: 0.3,
          side: THREE.DoubleSide
      });
      const ground = new THREE.Mesh(groundGeometry, groundMaterial);
      ground.rotation.x = -Math.PI / 2;
      ground.receiveShadow = true;
      scene.add(ground);

      // Road (with lane markings)
      const roadGeometry = new THREE.PlaneGeometry(50, 500);
      const roadMaterial = new THREE.MeshStandardMaterial({
          color: 0x222222,
          roughness: 0.8,
          metalness: 0.2
      });
      const road = new THREE.Mesh(roadGeometry, roadMaterial);
      road.rotation.x = -Math.PI / 2;
      road.position.y = 0.01;
      scene.add(road);

      // Lane markings
      for (let z = -250; z <= 250; z += 10) {
          const lineGeometry = new THREE.BoxGeometry(0.2, 0.01, 5);
          const lineMaterial = new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 0.5 });
          const line = new THREE.Mesh(lineGeometry, lineMaterial);
          line.position.set(0, 0.02, z);
          scene.add(line);
      }

      // OrbitControls for exploration
      const controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.target.set(0, 1, 0);
      controls.enableDamping = true;
      controls.dampingFactor = 0.05;

      // Transformation state
      let isFlyingMode = true;
      const transformButton = document.getElementById('transformButton');
      const speedDisplay = document.getElementById('speedValue');
      let currentSpeed = 0;
      let maxSpeed = isFlyingMode ? 200 : 150;

      // Load TWEEN.js for animations
      const script = document.createElement('script');
      script.src = 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@18.6.4/dist/tween.umd.js';
      script.onload = () => {
          transformButton.addEventListener('click', transformCar);
      };
      document.head.appendChild(script);

      // Transformation animation
      function transformCar() {
          isFlyingMode = !isFlyingMode;
          maxSpeed = isFlyingMode ? 200 : 150;
          transformButton.textContent = isFlyingMode ? 'Switch to Road Mode' : 'Switch to Flying Mode';

          if (isFlyingMode) {
              // Transform to flying mode
              spoiler.visible = false;

              // Animate wheels folding in
              const wheelFoldIn = new TWEEN.Tween({ y: 0.3 })
                    .to({ y: 1 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        wheelFL.position.y = obj.y;
                        wheelFR.position.y = obj.y;
                        wheelBL.position.y = obj.y;
                        wheelBR.position.y = obj.y;
                    });

              // Animate wings unfolding
              const wingUnfold = new TWEEN.Tween({ z: 0, rotation: 0 })
                    .to({ z: 1.6, rotation: Math.PI / 4 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        wingLeft.position.z = obj.z;
                        wingRight.position.z = -obj.z;
                        wingLeft.rotation.z = obj.rotation;
                        wingRight.rotation.z = -obj.rotation;
                    });

              // Animate exhaust appearing
              const exhaustAppear = new TWEEN.Tween({ opacity: 0 })
                    .to({ opacity: 0.8 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        exhaustLeft.material.opacity = obj.opacity;
                        exhaustRight.material.opacity = obj.opacity;
                    });

              // Animate car lifting up
              const liftUp = new TWEEN.Tween(car.position)
                    .to({ y: 2 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut);

              // Start animations
              wheelFoldIn.start();
              wingUnfold.start();
              exhaustAppear.start();
              liftUp.start();

          } else {
              // Transform to road mode
              spoiler.visible = true;

              // Animate wheels unfolding
              const wheelUnfold = new TWEEN.Tween({ y: 1 })
                    .to({ y: 0.3 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        wheelFL.position.y = obj.y;
                        wheelFR.position.y = obj.y;
                        wheelBL.position.y = obj.y;
                        wheelBR.position.y = obj.y;
                    });

              // Animate wings folding in
              const wingFold = new TWEEN.Tween({ z: 1.6, rotation: Math.PI / 4 })
                    .to({ z: 0, rotation: 0 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        wingLeft.position.z = obj.z;
                        wingRight.position.z = -obj.z;
                        wingLeft.rotation.z = obj.rotation;
                        wingRight.rotation.z = -obj.rotation;
                    });

              // Animate exhaust disappearing
              const exhaustDisappear = new TWEEN.Tween({ opacity: 0.8 })
                    .to({ opacity: 0 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut)
                    .onUpdate((obj) => {
                        exhaustLeft.material.opacity = obj.opacity;
                        exhaustRight.material.opacity = obj.opacity;
                    });

              // Animate car lowering down
              const lowerDown = new TWEEN.Tween(car.position)
                    .to({ y: 0.5 }, 800)
                    .easing(TWEEN.Easing.Quadratic.InOut);

              // Start animations
              wheelUnfold.start();
              wingFold.start();
              exhaustDisappear.start();
              lowerDown.start();
          }
      }

      // Simulate movement and speed
      function updateSpeed() {
          if (isFlyingMode) {
              currentSpeed = Math.sin(Date.now() * 0.002) * 50 + 100;
          } else {
              currentSpeed = Math.sin(Date.now() * 0.0015) * 30 + 80;
          }
          speedDisplay.textContent = Math.floor(currentSpeed);
      }

      // Animation loop
      function animate() {
          requestAnimationFrame(animate);
          TWEEN.update();

          // Hover effect in flying mode
          if (isFlyingMode) {
              car.position.y = 1 + 0.03 * Math.sin(Date.now() * 0.002);
          }

          // Neon pulse effect
          const neonPulse = 0.5 + 0.5 * Math.sin(Date.now() * 0.003);
          accentMaterial.emissiveIntensity = neonPulse * 1.5;
          rimMaterial.emissiveIntensity = neonPulse * 2;
          headlightMaterial.emissiveIntensity = 2 + neonPulse;

          // Update speed display
          updateSpeed();

          controls.update();
          renderer.render(scene, camera);
      }
      animate();

      // Handle window resize
      window.addEventListener('resize', () => {
          camera.aspect = window.innerWidth / window.innerHeight;
          camera.updateProjectionMatrix();
          renderer.setSize(window.innerWidth, window.innerHeight);
      });
    </script>
  </body>
</html>
